<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Galería en línea de fotos">
  <meta name="author" content="GalleryOnline">

  <!-- Bootstrap core CSS -->
  <link th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
  <script th:src="@{/vendor/jquery/jquery.min.js}"></script> <!-- Si usas jQuery -->
  <script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Custom styles -->
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --dark-color: #3a0ca3;
      --light-color: #f8f9fa;
      --text-dark: #2b2d42;
      --text-light: #8d99ae;
      --success-color: #4cc9f0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
      color: var(--text-dark);
    }

    .btn-add-photo i {
      font-size: 1.1rem;
    }

    /* Photo Grid */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      padding: 0 2rem;
      margin-bottom: 4rem;
    }

    /* Photo Card */
    .photo-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
    }

    .photo-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .photo-img-container {
      position: relative;
      overflow: hidden;
      height: 250px;
    }

    .photo-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .photo-card:hover .photo-img {
      transform: scale(1.05);
    }

    .photo-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      padding: 1rem;
      color: white;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .photo-card:hover .photo-overlay {
      transform: translateY(0);
    }

    .photo-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .photo-description {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .photo-content {
      padding: 1.5rem;
    }

    .photo-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }

    .btn-view {
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      padding: 0.5rem 1.2rem;
      border-radius: 50px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .btn-view:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
      color: white;
    }

    /* Modal Styles */
    .photo-modal .modal-content {
      border: none;
      border-radius: 15px;
      overflow: hidden;
    }

    .photo-modal .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-bottom: none;
    }

    .photo-modal .modal-title {
      font-weight: 600;
    }

    .photo-modal .modal-body {
      padding: 0;
    }

    .photo-modal .modal-footer {
      border-top: none;
      background: #f8f9fa;
    }

    .photo-modal img {
      width: 100%;
      height: auto;
      max-height: 70vh;
      object-fit: contain;
    }

    /* Back Button */
    .btn-back {
      background: white;
      color: var(--primary-color);
      border: 2px solid var(--primary-color);
      padding: 0.8rem 1.8rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      margin-top: 2rem;
    }

    .btn-back:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
    }

    .btn-back i {
      margin-right: 8px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 4rem 0;
      max-width: 600px;
      margin: 0 auto;
    }

    .empty-state i {
      font-size: 5rem;
      color: var(--accent-color);
      margin-bottom: 1.5rem;
      opacity: 0.7;
    }

    .empty-state h3 {
      font-size: 1.8rem;
      margin-bottom: 1rem;
      color: var(--text-dark);
    }

    .empty-state p {
      color: var(--text-light);
      margin-bottom: 2rem;
    }

    .photo-grid {
      grid-template-columns: 1fr;
      padding: 0 1rem;
    }

    .photo-img-container {
      height: 200px;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
      color: var(--text-dark);
      margin: 0;
      padding: 0;
    }

    /* Project Header */
    .project-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 3rem 0;
      margin-bottom: 3rem;
      position: relative;
      overflow: hidden;
    }

    .project-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjA1KSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3QgZmlsbD0idXJsKCNwYXR0ZXJuKSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIvPjwvc3ZnPg==');
      opacity: 0.3;
    }

    .project-header-content {
      position: relative;
      z-index: 1;
    }

    .project-description {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 700px;
      margin: 0 auto 1.5rem;
    }
    .btn-action i {
      margin-right: 8px;
    }
    /* Back Button */
    .btn-back {
      background: white;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 0.8rem 1.8rem;
      border-radius: 50px;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-right: 15px;
    }

    .btn-back:hover {
      background: var(--light-color);
      color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .btn-back i {
      margin-right: 8px;
    }

    .button-group {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
    }

    .album-card h3 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: var(--text-dark);
      display: flex;
      align-items: center;
    }

    .album-card h3 {
      margin-left: 10px;
      font-size: 0.7rem;
      padding: 0.35rem 0.6rem;
    }

    .album-card p {
      color: var(--text-light);
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      flex-grow: 1;
    }

    .btn-view {
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      padding: 0.6rem 1.5rem;
      border-radius: 50px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      font-size: 1rem;
    }

    .btn-view:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
      color: white;
    }

    .btn-view i {
      margin-right: 8px;
      font-size: 1rem;
    }

    /* Modal Styles */
    .modal-content {
      border: none;
      border-radius: 12px;
      overflow: hidden;
    }

    .modal-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      border-bottom: none;
    }

    .modal-title {
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .modal-title i {
      margin-right: 10px;
    }

    .modal-body {
      padding: 2rem;
    }

    .form-control {
      border-radius: 8px;
      padding: 0.8rem 1rem;
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 0.2rem rgba(72, 149, 239, 0.25);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .project-header {
        padding: 2rem 0;
      }
      .project-description {
        font-size: 1rem;
      }

      .button-group {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .btn-back {
        width: 100%;
        justify-content: center;
        margin-right: 0;
      }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .photo-grid {
        grid-template-columns: 1fr;
        padding: 0 1rem;
      }

      .photo-img-container {
        height: 200px;
      }
    }

    /* Photo Grid */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
      padding: 0 2rem;
      margin-bottom: 4rem;
    }

    /* Photo Card */
    .photo-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      position: relative;
    }

    .photo-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
    }

    .photo-img-container {
      position: relative;
      overflow: hidden;
      height: 250px;
    }

    .photo-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .photo-card:hover .photo-img {
      transform: scale(1.05);
    }

    .photo-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      padding: 1rem;
      color: white;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    .photo-card:hover .photo-overlay {
      transform: translateY(0);
    }

    /* Estilos para el input de archivo personalizado */
    .custom-file-input {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }

    .custom-file {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-bottom: 0;
    }

    .custom-file-label {
      position: relative;
      z-index: 2;
      width: 100%;
      height: calc(2.25rem + 2px);
      padding: 0.375rem 0.75rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .custom-file-label::after {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 3;
      display: block;
      height: calc(2.25rem + 2px);
      padding: 0.375rem 0.75rem;
      line-height: 1.5;
      color: #495057;
      content: "Search";
      background-color: #e9ecef;
      border-left: 1px solid #ced4da;
      border-radius: 0 0.25rem 0.25rem 0;
    }

    /* Estilos para el mensaje de éxito */
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: none;
    }

    /* Barra de progreso mejorada */
    .upload-progress-wrapper {
      margin: 1.5rem 0;
      padding: 0;
    }

    .progress-status {
      font-weight: 500;
      color: var(--primary-color);
    }

    .progress-percent {
      font-weight: 600;
      color: var(--dark-color);
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .file-counter {
      font-style: italic;
    }

    .current-file-num {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Estado de éxito */
    .upload-complete .progress-status {
      color: var(--success-color);
    }

    .upload-complete .progress-bar-fill {
      background: var(--success-color);
    }

    /* New styles for download functionality */
    .download-actions {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding: 0 2rem;
    }

    .btn-download-all {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 0.6rem 1.5rem;
      border-radius: 50px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
    }

    .btn-download-all:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4);
      color: white;
    }

    .btn-download-all i {
      margin-right: 8px;
    }

    .photo-checkbox {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .photo-card.selected {
      box-shadow: 0 0 0 3px var(--accent-color);
    }

    .download-selected {
      background: linear-gradient(45deg, #17a2b8, #20c997);
    }

    /* Loading animation for download */
    .download-loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .download-loading-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
    }

    .download-loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .download-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--primary-color);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      align-items: center;
    }

    .download-notification.error {
      background: #dc3545 !important;
    }

    .download-notification i {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .download-notification i.fa-exclamation-circle {
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .btn-delete-single {
      background: linear-gradient(45deg, #ff4d4d, #cc0000);
      color: white;
      border: none;
      padding: 0.6rem 1.5rem;
      border-radius: 50px;
      font-weight: 500;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(255, 77, 77, 0.3);
      font-size: 1rem;
    }

    .btn-delete-single:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 77, 77, 0.4);
      color: white;
    }

    .btn-delete-single i {
      margin-right: 8px;
    }
  </style>
</head>
<body>

<!-- Navigation -->
<div th:if="${isAdmin}" th:include="adm/template_admin.html::header"></div>
<div th:unless="${isAdmin}" th:include="usuario/template_usuario.html::header"></div>

<!-- Gallery Header -->
<div class="project-header text-center">
  <div class="container project-header-content">
    <p class="project-description">Add a new photo to the folders</p>
    <div class="button-group">
      <button type="button" class="btn-back" onclick="window.history.back()">
        <i class="fas fa-arrow-left"></i> Back to menu
      </button>

      <button class="btn-back" data-toggle="modal" data-target="#subirFotoModal">
        <i class="fas fa-plus-circle mr-2"></i> Add photo
      </button>
    </div>
  </div>
</div>

<!-- Photo Gallery -->
<div class="container" style="margin-bottom: 1rem;">
  <!-- Add download buttons above the gallery -->
  <div class="download-actions">
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; width: 100%;">
      <button class="btn-download-all" id="downloadAllBtn">
        <i class="fas fa-download"></i> Download All
      </button>
      <button class="btn-download-all download-selected" id="downloadSelectedBtn" disabled>
        <i class="fas fa-download"></i> Download Selected
      </button>
      <button class="btn-download-all btn-delete" id="deleteSelectedBtn" disabled th:if="${isAdmin}">
        <i class="fas fa-trash-alt"></i> Delete Selected
      </button>
    </div>
    <span id="selectedCount" style="margin-top: 10px; display: block; text-align: center;">0 selected</span>
  </div>
</div>

<div th:if="${not #lists.isEmpty(fotoAntes)}" class="photo-grid">
  <div th:each="fotoAntes : ${fotoAntes}" class="photo-card">
    <input type="checkbox" class="photo-checkbox" th:data-id="${fotoAntes.id}" th:data-url="@{/images/{img}(img=${fotoAntes.imagen})}" th:data-name="${fotoAntes.nombre}">
    <div class="photo-img-container">
      <div th:if="${#strings.endsWith(fotoAntes.imagen, '.mp4') or #strings.endsWith(fotoAntes.imagen, '.avi') or #strings.endsWith(fotoAntes.imagen, '.mov') or #strings.endsWith(fotoAntes.imagen, '.mkv')}">
        <video class="photo-img" controls>
          <source th:src="@{/images/{img}(img=${fotoAntes.imagen})}" type="video/mp4">
          Your browser does not support videos.
        </video>
      </div>
      <div th:unless="${#strings.endsWith(fotoAntes.imagen, '.mp4') or #strings.endsWith(fotoAntes.imagen, '.avi') or #strings.endsWith(fotoAntes.imagen, '.mov') or #strings.endsWith(fotoAntes.imagen, '.mkv')}">
        <img class="photo-img" th:src="@{/images/{img}(img=${fotoAntes.imagen})}" alt="Foto del álbum">
      </div>

      <div class="photo-overlay">
        <h5 class="photo-title" th:text="${fotoAntes.nombre}">Photo name</h5>
        <h8 class="photo-uploader" th:text="'Uploaded by: ' + ${fotoAntes.usuario.nombre}"></h8>
        <p class="photo-description"
           th:text="'Date: ' + ${#dates.format(fotoAntes.fecha, 'dd/MM/yyyy HH:mm')}">
          Fecha de subida
        </p>
      </div>
    </div>
    <div class="photo-content">
      <div class="photo-actions">
        <a href="javascript:void(0)" class="btn-view" data-toggle="modal" th:data-target="'#photoModal' + ${fotoAntes.id}">
          <i class="fas fa-expand mr-2"></i> Enlarge
        </a>
        <a href="javascript:void(0)" class="btn-delete-single" th:data-id="${fotoAntes.id}" th:if="${isAdmin}">
          <i class="fas fa-trash-alt mr-2"></i> Delete
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Download loading overlay -->
<div class="download-loading" id="downloadLoading">
  <div class="download-loading-content">
    <div class="download-loading-spinner"></div>
    <h4>Preparing your download...</h4>
    <p id="downloadProgressText">Downloading files: 0/0</p>
  </div>
</div>

<!-- Delete loading overlay -->
<div class="download-loading" id="deleteLoading">
  <div class="download-loading-content">
    <div class="download-loading-spinner"></div>
    <h4>Deleting files...</h4>
    <p id="deleteProgressText">Deleting files: 0/0</p>
  </div>
</div>

<!-- Download notification -->
<div class="download-notification" id="downloadNotification">
  <i class="fas fa-check-circle"></i>
  <span id="downloadNotificationText">Download complete!</span>
</div>

<!-- Delete notification -->
<div class="download-notification" id="deleteNotification">
  <i class="fas fa-check-circle"></i>
  <span id="deleteNotificationText">Delete complete!</span>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDownloadModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Download</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="confirmDownloadText">
        Are you sure you want to download these files?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmDownloadBtn">Download</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="confirmDeleteText">
        Are you sure you want to delete these files? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Empty State -->
<div th:if="${#lists.isEmpty(fotoAntes)}" class="empty-state">
  <i class="far fa-images"></i>
  <h3>There are no photos in this project</h3>
  <p>Start by adding photos to view them here</p>
</div>

<!-- Back Button -->
<div class="text-center">
  <button type="button" class="btn-back" onclick="window.history.back()">
    <i class="fas fa-arrow-left"></i> Back to home
  </button>
</div>

<!-- Modal para subir foto -->
<div class="modal fade" id="subirFotoModal" tabindex="-1" role="dialog" aria-labelledby="subirFotoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <form id="uploadForm" th:action="@{/fotos/save}" method="post" enctype="multipart/form-data">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="subirFotoModalLabel"><i class="fas fa-camera"></i> Upload new photo or video</h5>
          <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Mensaje de éxito -->
          <div id="successMessage" class="alert alert-success d-none">
            <i class="fas fa-check-circle"></i> Photo uploaded successfully!
          </div>

          <!-- Barra de progreso -->
          <div class="upload-progress-wrapper d-none mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span class="progress-status small">Uploading files...</span>
              <span class="progress-percent small font-weight-bold">0%</span>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar progress-bar-fill progress-bar-striped progress-bar-animated"
                   role="progressbar" style="width: 0%; background-color: #4e73df;"></div>
            </div>
            <div class="text-right mt-1">
              <small class="text-muted file-counter">File <span class="current-file-num">1</span> of <span class="total-files">0</span></small>
            </div>
          </div>

          <div class="form-group">
            <label for="nombre" class="font-weight-bold">Multimedia names</label>
            <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Name for the photo" required>
          </div>

          <input type="hidden" name="subalbum" th:value="${subAlbum.id}" />
          <input type="hidden" id="hora" name="hora" value="">

          <!-- File input -->
          <div class="form-group">
            <label for="img" class="font-weight-bold">Select Image or Video</label>
            <div class="custom-file">
              <input type="file" class="custom-file-input" id="img" name="img" accept="image/*,video/*,.heic,.heif" multiple required>
              <label class="custom-file-label" for="img">Choose file(s)</label>
            </div>
            <small class="form-text text-muted">You can select multiple files at once</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <span class="btn-text">Upload</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Photo Modals -->
<div th:each="fotoAntes : ${fotoAntes}">
  <div class="modal fade photo-modal" th:id="'photoModal' + ${fotoAntes.id}" tabindex="-1" role="dialog"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" th:id="'photoModalLabel' + ${fotoAntes.id}" th:text="${fotoAntes.nombre}">Foto Detalle</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Verifica si el archivo es un video o una imagen -->
          <div th:if="${#strings.endsWith(fotoAntes.imagen, '.mp4') or #strings.endsWith(fotoAntes.imagen, '.avi') or #strings.endsWith(fotoAntes.imagen, '.mov') or #strings.endsWith(fotoAntes.imagen, '.mkv')}">
            <video class="img-fluid video-content" id="videoModal" controls>
              <source th:src="@{/images/{img}(img=${fotoAntes.imagen})}" type="video/mp4">
              Your browser does not support videos.
            </video>
          </div>
          <div th:unless="${#strings.endsWith(fotoAntes.imagen, '.mp4') or #strings.endsWith(fotoAntes.imagen, '.avi') or #strings.endsWith(fotoAntes.imagen, '.mov') or #strings.endsWith(fotoAntes.imagen, '.mkv')}">
            <img class="img-fluid" th:src="@{/images/{img}(img=${fotoAntes.imagen})}" alt="Foto detallada">
          </div>
        </div>
        <div class="modal-footer">
          <p class="photo-uploader" th:text="'Uploaded by: ' + ${fotoAntes.usuario.nombre}"></p>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
  $(document).ready(function() {
    // Set current time
    function setCurrentTime() {
      const now = new Date();
      document.getElementById('hora').value = now.toTimeString().substring(0, 5);
    }

    // Initialize modal behaviors
    function initModal() {
      // Set time on modal show
      $('#subirFotoModal').on('show.bs.modal', setCurrentTime);

      // Reset modal on close
      $('#subirFotoModal').on('hidden.bs.modal', function() {
        $(this).find('form')[0].reset();
        $(this).find('.custom-file-label').text('Choose file(s)');
        $('#successMessage').addClass('d-none');

        // Pause any videos
        $(this).find('video').each(function() {
          this.pause();
          this.currentTime = 0;
        });
      });

      // Update file input label
      $('.custom-file-input').on('change', function() {
        const files = this.files;
        let label = 'Choose file(s)';

        if (files.length > 0) {
          if (files.length === 1) {
            label = files[0].name;
          } else {
            label = `${files.length} files selected`;
          }
        }

        $(this).next('.custom-file-label').text(label);
      });
    }

    // AJAX form submission
    function initUploadForm() {
      $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);
        const files = $('#img')[0].files;
        const totalFiles = files.length;

        // UI updates
        const progressWrapper = $('.upload-progress-wrapper');
        const submitBtn = $('#submitBtn');
        const btnText = submitBtn.find('.btn-text');
        const spinner = submitBtn.find('.spinner-border');

        progressWrapper.removeClass('d-none');
        $('.total-files').text(totalFiles);
        $('.current-file-num').text('1');
        $('.progress-bar-fill').css('width', '0%');
        $('.progress-percent').text('0%');

        submitBtn.prop('disabled', true);
        btnText.text('Uploading...');
        spinner.removeClass('d-none');

        // AJAX request
        $.ajax({
          url: $(form).attr('action'),
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          xhr: function() {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener('progress', function(e) {
              if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);

                $('.progress-bar-fill').css('width', percent + '%');
                $('.progress-percent').text(percent + '%');

                if (totalFiles > 1) {
                  const currentFile = Math.min(Math.floor(percent / (100 / totalFiles)) + 1, totalFiles);
                  $('.current-file-num').text(currentFile);
                }
              }
            });

            return xhr;
          },
          success: function(response) {
            // Success handling
            $('.progress-status').text('Upload complete!');
            $('.progress-bar-fill').removeClass('progress-bar-animated');

            // Show success message
            $('#successMessage').removeClass('d-none');

            // Close modal after 1.5 seconds
            setTimeout(() => {
              $('#subirFotoModal').modal('hide');

              // If there's a redirect URL in the response
              if (response.redirect) {
                window.location.href = response.redirect;
              } else {
                // Reload page after closing modal
                setTimeout(() => location.reload(), 500);
              }
            }, 1500);
          },
          error: function(xhr) {
            // Error handling
            $('.progress-status').text('Upload failed').addClass('text-danger');
            $('.progress-bar-fill').css('background-color', '#dc3545');

            setTimeout(() => {
              progressWrapper.addClass('d-none');
              submitBtn.prop('disabled', false);
              btnText.text('Upload');
              spinner.addClass('d-none');

              // Reset progress bar
              $('.progress-bar-fill').css({
                'width': '0%',
                'background-color': '#4e73df'
              }).addClass('progress-bar-animated');
              $('.progress-status').text('Uploading files...').removeClass('text-danger');
            }, 3000);

            // Show error message
            const errorMsg = xhr.responseJSON?.message || 'An error occurred during upload';
            alert(`Error: ${errorMsg}`);
          }
        });
      });
    }

    // Helper function to get file extension
    function getFileExtension(url) {
      const lastDot = url.lastIndexOf('.');
      if (lastDot === -1) return '';
      return url.substring(lastDot);
    }

    // Function to generate unique filename
    function generateUniqueFilename(originalName, url, index = 0) {
      const timestamp = new Date().getTime();
      const randomString = Math.random().toString(36).substring(2, 8);
      return `${originalName}_${timestamp}_${randomString}_${index}${getFileExtension(url)}`;
    }

    // Function to show notification
    function showNotification(message, type = 'success', isDelete = false) {
      const notification = isDelete ? $('#deleteNotification') : $('#downloadNotification');
      const notificationText = isDelete ? $('#deleteNotificationText') : $('#downloadNotificationText');

      // Set notification style based on type
      if (type === 'error') {
        notification.css('background', '#dc3545');
        notification.find('i').removeClass('fa-check-circle').addClass('fa-exclamation-circle');
      } else {
        notification.css('background', 'var(--primary-color)');
        notification.find('i').removeClass('fa-exclamation-circle').addClass('fa-check-circle');
      }

      notificationText.text(message);
      notification.fadeIn();

      // Hide notification after 3 seconds
      setTimeout(() => {
        notification.fadeOut();
      }, 3000);
    }

    // Function to delete a single photo - MODIFICADO PARA HTTPS
    function deleteSinglePhoto(photoId) {
      $.ajax({
        url: '/fotos/delete/' + photoId,
        type: 'DELETE', // Cambiado a DELETE
        headers: {
          'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') // Añadir CSRF para seguridad
        },
        success: function(response) {
          showNotification('Photo deleted successfully', 'success', true);
          $(`.photo-checkbox[data-id="${photoId}"]`).closest('.photo-card').remove();
          if ($('.photo-card').length === 0) {
            setTimeout(() => location.reload(), 500);
          }
        },
        error: function(xhr) {
          showNotification('Error deleting photo', 'error', true);
        }
      });
    }

    // Function to delete multiple photos - MODIFICADO PARA HTTPS
    function deleteMultiplePhotos(photoIds) {
      const deleteOverlay = $('#deleteLoading');
      const progressText = $('#deleteProgressText');
      const totalPhotos = photoIds.length;

      deleteOverlay.css('display', 'flex');
      progressText.text(`Deleting files: 0/${totalPhotos}`);

      let successCount = 0;

      photoIds.forEach((photoId, index) => {
        setTimeout(() => {
          progressText.text(`Deleting files: ${index + 1}/${totalPhotos}`);

          $.ajax({
            url: '/fotos/delete/' + photoId,
            type: 'DELETE', // Cambiado a DELETE
            headers: {
              'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content') // Añadir CSRF para seguridad
            },
            success: function(response) {
              successCount++;
              $(`.photo-checkbox[data-id="${photoId}"]`).closest('.photo-card').remove();

              if (index === photoIds.length - 1) {
                setTimeout(() => {
                  deleteOverlay.hide();
                  showNotification(`Successfully deleted ${successCount} file${successCount > 1 ? 's' : ''}`, 'success', true);
                  if ($('.photo-card').length === 0) {
                    setTimeout(() => location.reload(), 500);
                  }
                }, 500);
              }
            },
            error: function(xhr) {
              console.error('Error deleting photo with ID:', photoId);
              if (index === photoIds.length - 1) {
                setTimeout(() => {
                  deleteOverlay.hide();
                  showNotification(`Deleted ${successCount} of ${totalPhotos} files`, successCount === totalPhotos ? 'success' : 'error', true);
                }, 500);
              }
            }
          });
        }, index * 300);
      });
    }

    // New code for download and delete functionality
    function initDownloadAndDeleteFunctions() {
      let selectedPhotos = [];
      let currentDownloadQueue = [];

      // Handle checkbox selection
      $('.photo-grid').on('change', '.photo-checkbox', function() {
        const photoId = $(this).data('id');
        const photoUrl = $(this).data('url');
        const photoName = $(this).data('name');
        const isChecked = $(this).is(':checked');

        // Toggle selected class on card
        $(this).closest('.photo-card').toggleClass('selected', isChecked);

        // Update selected photos array
        if (isChecked) {
          selectedPhotos.push({ id: photoId, url: photoUrl, name: photoName });
        } else {
          selectedPhotos = selectedPhotos.filter(photo => photo.id !== photoId);
        }

        // Update UI
        $('#selectedCount').text(selectedPhotos.length + ' selected');
        $('#downloadSelectedBtn').prop('disabled', selectedPhotos.length === 0);
        $('#deleteSelectedBtn').prop('disabled', selectedPhotos.length === 0);
      });

      // Download all photos
      $('#downloadAllBtn').on('click', function() {
        const photos = [];
        $('.photo-checkbox').each(function() {
          photos.push({
            url: $(this).data('url'),
            name: $(this).data('name')
          });
        });

        if (photos.length > 0) {
          // Show confirmation modal
          $('#confirmDownloadText').html(`You are about to download <strong>${photos.length}</strong> file${photos.length > 1 ? 's' : ''}.<br>Do you want to continue?`);
          $('#confirmDownloadBtn').off('click').on('click', function() {
            $('#confirmDownloadModal').modal('hide');
            downloadMultipleFiles(photos);
          });
          $('#confirmDownloadModal').modal('show');
        } else {
          // Show notification when no files are available
          showNotification('No files available to download', 'error');
        }
      });

      // Download selected photos
      $('#downloadSelectedBtn').on('click', function() {
        if (selectedPhotos.length > 0) {
          // Show confirmation modal
          $('#confirmDownloadText').html(`You are about to download <strong>${selectedPhotos.length}</strong> selected file${selectedPhotos.length > 1 ? 's' : ''}.<br>Do you want to continue?`);
          $('#confirmDownloadBtn').off('click').on('click', function() {
            $('#confirmDownloadModal').modal('hide');
            downloadMultipleFiles(selectedPhotos);
          });
          $('#confirmDownloadModal').modal('show');
        } else {
          // Show notification when no files are selected
          showNotification('Please select at least one file to download', 'error');
        }
      });

      // Delete selected photos
      $('#deleteSelectedBtn').on('click', function() {
        if (selectedPhotos.length > 0) {
          // Show confirmation modal
          $('#confirmDeleteText').html(`You are about to delete <strong>${selectedPhotos.length}</strong> selected file${selectedPhotos.length > 1 ? 's' : ''}.<br>This action cannot be undone.`);
          $('#confirmDeleteBtn').off('click').on('click', function() {
            $('#confirmDeleteModal').modal('hide');
            const photoIds = selectedPhotos.map(photo => photo.id);
            deleteMultiplePhotos(photoIds);
          });
          $('#confirmDeleteModal').modal('show');
        } else {
          // Show notification when no files are selected
          showNotification('Please select at least one file to delete', 'error', true);
        }
      });

      // Handle single photo delete
      $('.photo-card, .photo-modal').on('click', '.btn-delete-single', function(e) {
        e.preventDefault();
        const photoId = $(this).data('id');

        // Show confirmation modal
        $('#confirmDeleteText').html(`You are about to delete this file.<br>This action cannot be undone.`);
        $('#confirmDeleteBtn').off('click').on('click', function() {
          $('#confirmDeleteModal').modal('hide');
          deleteSinglePhoto(photoId);
        });
        $('#confirmDeleteModal').modal('show');
      });

      // Function to download multiple files
      function downloadMultipleFiles(files) {
        if (files.length === 0) return;

        currentDownloadQueue = files;
        const loadingOverlay = $('#downloadLoading');
        const progressText = $('#downloadProgressText');

        // Show loading overlay
        loadingOverlay.css('display', 'flex');
        progressText.text(`Downloading files: 0/${files.length}`);

        // Download each file with a small delay between them
        files.forEach((file, index) => {
          setTimeout(() => {
            // Update progress
            progressText.text(`Downloading files: ${index + 1}/${files.length}`);

            // Generate unique filename
            const uniqueName = generateUniqueFilename(file.name, file.url, index);

            // Create invisible download link
            const link = document.createElement('a');
            link.href = file.url;
            link.download = uniqueName;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // If it's the last file, close overlay and show notification
            if (index === files.length - 1) {
              setTimeout(() => {
                loadingOverlay.hide();
                showNotification(`Successfully downloaded ${files.length} file${files.length > 1 ? 's' : ''}`);
              }, 500);
            }
          }, index * 300); // Small delay between downloads
        });
      }
    }

    // Initialize everything
    setCurrentTime();
    initModal();
    initUploadForm();
    initDownloadAndDeleteFunctions();
  });
</script>

</body>
</html>